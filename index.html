<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETRO_CSSA - Capital Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* === KOLORY I ZMIENNE CSS === */
        :root {
            --primary-blue: #1B365D;
            --secondary-blue: #2E5984;
            --accent-blue: #4A90BE;
            --success-green: #34C759;
            --warning-orange: #FF9500;
            --error-red: #FF3B30;
            --background-primary: #FAFBFC;
            --background-secondary: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* === PODSTAWOWE STYLE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--background-primary) 0%, #E8F4F8 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        /* === HEADER Z INFORMACJƒÑ O U≈ªYTKOWNIKU === */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 3.5em;
            font-weight: 800;
            margin-bottom: 12px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* === INFORMACJE O U≈ªYTKOWNIKU === */
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }
        .user-badge {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 25px;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .role-developer {
            background: linear-gradient(135deg, var(--accent-blue), #7BB3D9);
        }
        .role-pm {
            background: linear-gradient(135deg, var(--success-green), #20C997);
        }
        .switch-role-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
        }

        /* === ZAK≈ÅADKI NAWIGACJI === */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.8);
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 20px 24px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .tab.hidden {
            display: none !important;
        }
        .tab.active {
            color: var(--primary-blue);
            font-weight: 600;
            border-bottom: 3px solid var(--accent-blue);
        }
        .tab:hover {
            background: rgba(27, 54, 93, 0.05);
            color: var(--primary-blue);
        }

        /* === ZAWARTO≈öƒÜ ZAK≈ÅADEK === */
        .tab-content {
            display: none;
            padding: 40px;
            min-height: 600px;
        }
        .tab-content.active {
            display: block;
        }

        /* === KARTY I ELEMENTY === */
        .modern-card {
            background: var(--background-secondary);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        /* === PRZYCISKI === */
        .btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--primary-blue) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 8px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #28A745 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #FD7E14 100%);
        }
        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* === ELEMENTY DOSTƒòPNE TYLKO DLA PM === */
        .pm-only {
            display: block;
        }
        .pm-only.hidden {
            display: none !important;
        }

        /* === LISTA U≈ªYTKOWNIK√ìW TEAMS === */
        .team-members {
            display: grid;
            gap: 16px;
        }
        .member-card {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .member-status {
            font-size: 1.5em;
        }
        .member-info {
            flex: 1;
        }
        .member-role {
            background: var(--accent-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85em;
        }

        /* === KARTY PLANNING POKER === */
        .poker-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 16px;
            max-width: 900px;
            margin: 32px auto;
        }
        .poker-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 20px 16px;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-blue);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            user-select: none;
        }
        .poker-card:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        .poker-card.selected {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
            color: white;
            transform: translateY(-4px) scale(1.1);
        }
        .poker-card.special {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #FFB84D 100%);
            color: white;
        }

        /* === LISTA ZADA≈É === */
        .story-list {
            display: grid;
            gap: 16px;
        }
        .story-item {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--accent-blue);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .story-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        .story-item.selected {
            border-left-color: var(--primary-blue);
            background: rgba(27, 54, 93, 0.05);
        }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) {
            .container {
                margin: 12px;
            }
            .header h1 {
                font-size: 2.5em;
            }
            .user-info {
                position: static;
                margin-top: 20px;
            }
            .poker-cards {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- === HEADER Z INFORMACJAMI O U≈ªYTKOWNIKU === -->
        <div class="header">
            <h1>üîÑ RETRO_CSSA</h1>
            <p>Platforma retrospektyw zespo≈Çowych - Capital Service</p>
            
            <!-- Informacje o aktualnym u≈ºytkowniku -->
            <div class="user-info">
                <div id="userBadge" class="user-badge">
                    <div><strong id="userName">Jan Kowalski</strong></div>
                    <div id="userRole">Developer</div>
                </div>
                <button class="switch-role-btn" onclick="switchUserRole()">üîÑ Zmie≈Ñ rolƒô (demo)</button>
            </div>
        </div>
        
        <!-- === NAWIGACJA ZAK≈ÅADEK === -->
        <nav class="nav-tabs">
            <button class="tab" id="tab-setup" onclick="showTab('setup')" data-required-role="pm">‚öôÔ∏è Konfiguracja</button>
            <button class="tab active" id="tab-planning" onclick="showTab('planning')" data-required-role="developer,pm">üìã Planning Poker</button>
            <button class="tab" id="tab-checkin" onclick="showTab('checkin')" data-required-role="developer,pm">üëã Check-in</button>
            <button class="tab" id="tab-retro" onclick="showTab('retro')" data-required-role="developer,pm">üéØ Retrospektywa</button>
            <button class="tab" id="tab-accounts" onclick="showTab('accounts')" data-required-role="pm">üîó Konta</button>
            <button class="tab" id="tab-summary" onclick="showTab('summary')" data-required-role="pm">üìä Raport</button>
        </nav>
        
        <!-- === KONFIGURACJA (tylko PM) === -->
        <div id="setup" class="tab-content">
            <h2 style="margin-bottom: 32px; color: var(--primary-blue);">üöÄ Konfiguracja sesji retrospektywy</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <!-- Szablon retrospektywy - tylko Start/Stop/Continue -->
                <div class="modern-card">
                    <h3 style="color: var(--primary-blue); margin-bottom: 24px;">üìã Szablon retrospektywy</h3>
                    
                    <div style="background: rgba(27, 54, 93, 0.05); padding: 20px; border-radius: 12px; border: 2px solid var(--accent-blue);">
                        <h4 style="color: var(--primary-blue);">üîÑ Start/Stop/Continue</h4>
                        <p style="color: var(--text-secondary);">Klasyczny szablon agile - co zaczƒÖƒá, przestaƒá i kontynuowaƒá robiƒá</p>
                        <div style="margin-top: 12px; font-size: 0.9em; color: var(--text-secondary);">
                            ‚úÖ Aktywny szablon dla zespo≈Çu Capital Service
                        </div>
                    </div>
                </div>
                
                <!-- Zesp√≥≈Ç Capital Service z Teams -->
                <div class="modern-card">
                    <h3 style="color: var(--primary-blue); margin-bottom: 24px;">üë• Zesp√≥≈Ç Capital Service (z Teams)</h3>
                    
                    <div class="team-members" id="teamMembersList">
                        <!-- Lista cz≈Çonk√≥w zespo≈Çu bƒôdzie wygenerowana przez JavaScript -->
                    </div>
                    
                    <button class="btn btn-success" onclick="startRetrospective()">‚ñ∂Ô∏è Rozpocznij retrospektywƒô</button>
                </div>
            </div>
        </div>
        
        <!-- === PLANNING POKER === -->
        <div id="planning" class="tab-content active">
            <h2 style="margin-bottom: 32px; color: var(--primary-blue);">üìã Planning Poker - Szacowanie zada≈Ñ</h2>
            
            <!-- Dodawanie nowego zadania (PM) -->
            <div class="modern-card pm-only">
                <h3>‚ûï Dodaj nowe zadanie do szacowania</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;">
                    <input type="text" id="newStoryTitle" placeholder="Tytu≈Ç zadania" style="padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                    <input type="text" id="newStoryDescription" placeholder="Opis zadania" style="padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                </div>
                <button class="btn btn-success" onclick="addNewStory()">‚ûï Dodaj zadanie</button>
            </div>
            
            <!-- Lista zada≈Ñ do oszacowania -->
            <div class="modern-card">
                <h3>üìù Zadania do oszacowania</h3>
                <div class="story-list" id="storiesList">
                    <!-- Zadania bƒôdƒÖ wygenerowane przez JavaScript -->
                </div>
            </div>
            
            <!-- Karty szacowania -->
            <div class="modern-card">
                <h3>üéØ Oszacuj wybrane zadanie</h3>
                <div id="selectedStoryDisplay">
                    <p style="color: var(--text-secondary);">Wybierz zadanie z listy powy≈ºej, aby rozpoczƒÖƒá szacowanie</p>
                </div>
                
                <h4 style="margin: 24px 0 16px;">Wybierz swojƒÖ estymacjƒô (Story Points):</h4>
                <div class="poker-cards">
                    <!-- Pe≈Çna skala Fibonacci + specjalne karty -->
                    <div class="poker-card" onclick="selectEstimation(0.5)">¬Ω</div>
                    <div class="poker-card" onclick="selectEstimation(1)">1</div>
                    <div class="poker-card" onclick="selectEstimation(2)">2</div>
                    <div class="poker-card" onclick="selectEstimation(3)">3</div>
                    <div class="poker-card" onclick="selectEstimation(5)">5</div>
                    <div class="poker-card" onclick="selectEstimation(8)">8</div>
                    <div class="poker-card" onclick="selectEstimation(13)">13</div>
                    <div class="poker-card" onclick="selectEstimation(21)">21</div>
                    <div class="poker-card" onclick="selectEstimation(34)">34</div>
                    <div class="poker-card special" onclick="selectEstimation('?')">?</div>
                    <div class="poker-card special" onclick="selectEstimation('‚àû')">‚àû</div>
                    <div class="poker-card special" onclick="selectEstimation('‚òï')">‚òï</div>
                </div>
                
                <div style="text-align: center; margin: 24px 0;">
                    <p>Twoja estymacja: <strong id="currentEstimation">Nie wybrano</strong></p>
                    <button class="btn" onclick="submitEstimation()">‚úÖ Zatwierd≈∫ g≈Ços</button>
                    <button class="btn btn-warning pm-only" onclick="revealAllVotes()">üëÅÔ∏è Ujawnij g≈Çosy zespo≈Çu</button>
                </div>
            </div>
        </div>
        
        <!-- === CHECK-IN === -->
        <div id="checkin" class="tab-content">
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: var(--primary-blue); margin-bottom: 24px;">üëã Check-in zespo≈Çu Capital Service</h2>
                
                <div class="modern-card" style="max-width: 600px; margin: 32px auto;">
                    <h3>üé≤ Icebreaker dnia</h3>
                    <p id="icebreakerQuestion">Gdyby≈õ m√≥g≈Ç/mog≈Ça wprowadziƒá jednƒÖ innowacjƒô do Capital Service, co by to by≈Ço?</p>
                    <button class="btn" onclick="generateNewIcebreaker()">üîÑ Nowy icebreaker</button>
                </div>
                
                <h3 style="margin: 32px 0 24px;">üòä Jaki jest Tw√≥j nastr√≥j dzisiaj?</h3>
                <div style="display: flex; justify-content: center; gap: 24px; margin: 40px 0; flex-wrap: wrap;">
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('excellent', 'ü§©')" title="Doskona≈Çy">ü§©</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('good', 'üòä')" title="Dobry">üòä</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('neutral', 'üòê')" title="Neutralny">üòê</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('bad', 'üòî')" title="S≈Çaby">üòî</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('terrible', 'üò´')" title="Okropny">üò´</span>
                </div>
                
                <div id="moodResponse" style="display: none; margin-top: 32px;">
                    <div class="modern-card" style="max-width: 500px; margin: 0 auto;">
                        <h4 style="color: var(--success-green);">‚úÖ Dziƒôkujemy za udzia≈Ç w check-in!</h4>
                        <p>Tw√≥j g≈Ços jest wa≈ºny dla zespo≈Çu Capital Service</p>
                        <button class="btn btn-success" onclick="showTab('retro')">Przejd≈∫ do retrospektywy ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- === RETROSPEKTYWA === -->
        <div id="retro" class="tab-content">
            <h2 style="color: var(--primary-blue); margin-bottom: 24px;">üéØ Tablica retrospektywy - Start/Stop/Continue</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 24px;">
                <!-- START Column -->
                <div style="background: rgba(52, 199, 89, 0.1); border-radius: 20px; padding: 32px;">
                    <h3 style="background: linear-gradient(135deg, var(--success-green) 0%, #20C997 100%); color: white; text-align: center; padding: 20px; border-radius: 16px; margin-bottom: 24px;">üöÄ START - Co zaczƒÖƒá robiƒá?</h3>
                    <div style="border: 3px dashed rgba(52, 199, 89, 0.3); border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; cursor: pointer;" onclick="addRetroNote('start')">+ Dodaj nowy pomys≈Ç</div>
                    <div id="start-notes"></div>
                </div>
                
                <!-- STOP Column -->
                <div style="background: rgba(255, 59, 48, 0.1); border-radius: 20px; padding: 32px;">
                    <h3 style="background: linear-gradient(135deg, var(--error-red) 0%, #E55353 100%); color: white; text-align: center; padding: 20px; border-radius: 16px; margin-bottom: 24px;">üõë STOP - Co przestaƒá robiƒá?</h3>
                    <div style="border: 3px dashed rgba(255, 59, 48, 0.3); border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; cursor: pointer;" onclick="addRetroNote('stop')">+ Dodaj nowy pomys≈Ç</div>
                    <div id="stop-notes"></div>
                </div>
                
                <!-- CONTINUE Column -->
                <div style="background: rgba(74, 144, 190, 0.1); border-radius: 20px; padding: 32px;">
                    <h3 style="background: linear-gradient(135deg, var(--accent-blue) 0%, #7BB3D9 100%); color: white; text-align: center; padding: 20px; border-radius: 16px; margin-bottom: 24px;">‚úÖ CONTINUE - Co robiƒá dalej?</h3>
                    <div style="border: 3px dashed rgba(74, 144, 190, 0.3); border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; cursor: pointer;" onclick="addRetroNote('continue')">+ Dodaj nowy pomys≈Ç</div>
                    <div id="continue-notes"></div>
                </div>
            </div>
        </div>
        
        <!-- === KONTA (tylko PM) === -->
        <div id="accounts" class="tab-content">
            <h2 style="color: var(--primary-blue); margin-bottom: 32px;">üîó Matchowanie kont Teams ‚Üî YouTrack</h2>
            
            <div class="modern-card">
                <h3>üìä Status mapowa≈Ñ Capital Service</h3>
                <p>Funkcja dostƒôpna po integracji z Microsoft Teams i YouTrack</p>
                <div style="background: rgba(74, 144, 190, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <strong>üîÑ Do zaimplementowania:</strong> Automatyczne mapowanie kont zespo≈Çu
                </div>
            </div>
        </div>
        
        <!-- === RAPORT (tylko PM) === -->
        <div id="summary" class="tab-content">
            <h2 style="color: var(--primary-blue); margin-bottom: 32px;">üìä Raport i podsumowanie</h2>
            
            <div class="modern-card" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%); color: white; text-align: center;">
                <h2>üöÄ Eksport i raportowanie</h2>
                <div style="margin: 24px 0;">
                    <p>Generowanie raport√≥w i eksport danych z retrospektyw Capital Service</p>
                </div>
                <button class="btn" style="background: rgba(255,255,255,0.15);" onclick="exportToTeams()">üì§ Wy≈õlij do Teams</button>
                <button class="btn" style="background: rgba(255,255,255,0.15);" onclick="updateYouTrack()">üîÑ Zaktualizuj YouTrack</button>
                <button class="btn" style="background: rgba(255,255,255,0.15);" onclick="generatePDFReport()">üìÑ Raport PDF</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // === KONFIGURACJA U≈ªYTKOWNIK√ìW I R√ìL (MOCK DATA) ===
        // =====================================================
        
        // MOCK: Aktualny u≈ºytkownik - w przysz≈Ço≈õci pobierany z Microsoft/Teams
        let currentUser = {
            id: "user_001",
            name: "Jan Kowalski",
            email: "jan.kowalski@capitalservice.pl",
            role: "developer", // developer lub pm
            avatar: "üë®‚Äçüíª"
        };

        // MOCK: Lista cz≈Çonk√≥w zespo≈Çu Capital Service z Teams
        // TODO: Po integracji z Teams API odkomentowaƒá poni≈ºsze linie:
        /*
        async function loadTeamMembersFromTeams() {
            const response = await fetch('/api/teams/members');
            const members = await response.json();
            return members;
        }
        */
        
        const teamMembers = [
            {
                id: "user_001",
                name: "Jan Kowalski", 
                email: "jan.kowalski@capitalservice.pl",
                role: "developer",
                presence: "online", // online, offline, away, busy
                avatar: "üë®‚Äçüíª"
            },
            {
                id: "user_002", 
                name: "Anna Nowak",
                email: "anna.nowak@capitalservice.pl", 
                role: "tester",
                presence: "away",
                avatar: "üë©‚Äçüî¨"
            },
            {
                id: "user_003",
                name: "Monika Capital",
                email: "monika.capital@capitalservice.pl",
                role: "pm", 
                presence: "online",
                avatar: "üë©‚Äçüíº"
            },
            {
                id: "user_004",
                name: "Piotr Kowalczyk", 
                email: "piotr.kowalczyk@capitalservice.pl",
                role: "developer",
                presence: "busy",
                avatar: "üë®‚Äçüíª"
            }
        ];

        // ============================================
        // === KONTROLA DOSTƒòPU OPARTA NA ROLACH ===
        // ============================================
        
        // Definicja uprawnie≈Ñ dla ka≈ºdej roli
        const rolePermissions = {
            developer: {
                allowedTabs: ["planning", "checkin", "retro"],
                canExport: false,
                canManageUsers: false,
                canRevealVotes: false
            },
            pm: {
                allowedTabs: ["setup", "planning", "checkin", "retro", "accounts", "summary"],
                canExport: true,
                canManageUsers: true, 
                canRevealVotes: true
            }
        };

        // Sprawd≈∫ czy u≈ºytkownik ma dostƒôp do konkretnej funkcji
        function hasPermission(permission) {
            const userRole = currentUser.role;
            return rolePermissions[userRole][permission] || false;
        }

        // Aktualizuj interfejs u≈ºytkownika na podstawie roli
        function updateUIForCurrentUser() {
            // Aktualizuj informacje o u≈ºytkowniku w headerze
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = 
                currentUser.role === 'pm' ? 'Project Manager' : 'Developer';
            
            // Ustaw kolor znaczka roli
            const userBadge = document.getElementById('userBadge');
            userBadge.className = `user-badge role-${currentUser.role}`;
            
            // Poka≈º/ukryj zak≈Çadki na podstawie uprawnie≈Ñ
            const allowedTabs = rolePermissions[currentUser.role].allowedTabs;
            document.querySelectorAll('.tab').forEach(tab => {
                const tabId = tab.id.replace('tab-', '');
                if (allowedTabs.includes(tabId)) {
                    tab.classList.remove('hidden');
                } else {
                    tab.classList.add('hidden');
                }
            });
            
            // Poka≈º/ukryj elementy dostƒôpne tylko dla PM
            const isPM = currentUser.role === 'pm';
            document.querySelectorAll('.pm-only').forEach(element => {
                if (isPM) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            });
        }

        // Prze≈ÇƒÖcz rolƒô u≈ºytkownika (tylko do demonstracji)
        function switchUserRole() {
            if (currentUser.role === 'developer') {
                currentUser.role = 'pm';
                currentUser.name = 'Monika Capital';
                currentUser.email = 'monika.capital@capitalservice.pl';
                currentUser.avatar = 'üë©‚Äçüíº';
            } else {
                currentUser.role = 'developer';
                currentUser.name = 'Jan Kowalski';
                currentUser.email = 'jan.kowalski@capitalservice.pl';
                currentUser.avatar = 'üë®‚Äçüíª';
            }
            
            updateUIForCurrentUser();
            showFirstAvailableTab();
        }

        // =======================================
        // === NAWIGACJA MIƒòDZY ZAK≈ÅADKAMI ===
        // =======================================
        
        function showTab(tabName) {
            // Sprawd≈∫ czy u≈ºytkownik ma dostƒôp do tej zak≈Çadki
            const allowedTabs = rolePermissions[currentUser.role].allowedTabs;
            if (!allowedTabs.includes(tabName)) {
                alert(`‚ùå Brak dostƒôpu do zak≈Çadki "${tabName}". Wymagana rola: PM`);
                return;
            }

            // Ukryj wszystkie zak≈Çadki
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Poka≈º wybranƒÖ zak≈Çadkƒô
            document.getElementById(tabName).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function showFirstAvailableTab() {
            const allowedTabs = rolePermissions[currentUser.role].allowedTabs;
            const firstTab = allowedTabs[0];
            showTab(firstTab);
        }

        // ========================================
        // === GENEROWANIE LISTY CZ≈ÅONK√ìW ZESPO≈ÅU ===
        // ========================================
        
        function displayTeamMembers() {
            const container = document.getElementById('teamMembersList');
            
            // TODO: Po integracji z Teams API zastƒÖp poni≈ºsze wywo≈Çaniem:
            // const members = await loadTeamMembersFromTeams();
            
            const presenceIcons = {
                online: 'üü¢',
                offline: '‚ö™', 
                away: 'üü°',
                busy: 'üî¥'
            };
            
            container.innerHTML = teamMembers.map(member => `
                <div class="member-card">
                    <span class="member-status">${presenceIcons[member.presence]} ${member.avatar}</span>
                    <div class="member-info">
                        <div style="font-weight: 600;">${member.name}</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">${member.email}</div>
                    </div>
                    <span class="member-role">${member.role.toUpperCase()}</span>
                </div>
            `).join('');
        }

        // ===================================
        // === ZARZƒÑDZANIE ZADANIAMI ===
        // ===================================
        
        // Lista zada≈Ñ do oszacowania
        let stories = [
            {
                id: 1,
                title: "üîê Implementacja logowania OAuth 2.0",
                description: "Integracja z Microsoft Azure AD dla zespo≈Çu Capital Service",
                estimations: {},
                finalEstimation: null,
                assignee: null
            },
            {
                id: 2,
                title: "üìä Dashboard z metrykami retrospektyw", 
                description: "Widok statystyk dla Project Manager√≥w Capital Service",
                estimations: {},
                finalEstimation: null,
                assignee: null
            }
        ];
        
        let selectedStoryId = null;
        let currentEstimation = null;

        // Wy≈õwietl listƒô zada≈Ñ
        function displayStories() {
            const container = document.getElementById('storiesList');
            
            if (stories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Brak zada≈Ñ do oszacowania. PM mo≈ºe dodaƒá nowe zadania.</p>';
                return;
            }
            
            container.innerHTML = stories.map(story => `
                <div class="story-item ${selectedStoryId === story.id ? 'selected' : ''}" onclick="selectStory(${story.id})">
                    <div style="font-weight: 600; margin-bottom: 8px;">${story.title}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px;">${story.description}</div>
                    <div style="font-size: 0.85em; color: var(--text-tertiary);">
                        ID: ${story.id} | 
                        Estymacja: ${story.finalEstimation ? story.finalEstimation + ' SP' : 'Nie oszacowano'} |
                        Przypisane: ${story.assignee || 'Nieprzypisane'}
                    </div>
                </div>
            `).join('');
        }

        // Wybierz zadanie do oszacowania
        function selectStory(storyId) {
            selectedStoryId = storyId;
            const story = stories.find(s => s.id === storyId);
            
            if (story) {
                document.getElementById('selectedStoryDisplay').innerHTML = `
                    <div style="background: rgba(74, 144, 190, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                        <h4 style="color: var(--primary-blue); margin-bottom: 8px;">${story.title}</h4>
                        <p style="margin-bottom: 8px;">${story.description}</p>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">
                            <strong>Status:</strong> ${story.finalEstimation ? 'Oszacowane (' + story.finalEstimation + ' SP)' : 'Oczekuje na oszacowanie'}
                        </div>
                    </div>
                `;
                
                // Przywr√≥ƒá poprzedniƒÖ estymacjƒô u≈ºytkownika je≈õli istnieje
                const userEstimation = story.estimations[currentUser.name];
                if (userEstimation) {
                    selectEstimation(userEstimation);
                }
            }
            
            displayStories(); // Od≈õwie≈º listƒô ≈ºeby pokazaƒá zaznaczenie
        }

        // Dodaj nowe zadanie (tylko PM)
        function addNewStory() {
            if (!hasPermission('canManageUsers')) {
                alert('‚ùå Tylko PM mo≈ºe dodawaƒá zadania');
                return;
            }
            
            const title = document.getElementById('newStoryTitle').value.trim();
            const description = document.getElementById('newStoryDescription').value.trim();
            
            if (!title) {
                alert('‚ùå Wprowad≈∫ tytu≈Ç zadania');
                return;
            }
            
            const newStory = {
                id: Date.now(),
                title: title,
                description: description || 'Brak szczeg√≥≈Çowego opisu',
                estimations: {},
                finalEstimation: null,
                assignee: null
            };
            
            stories.push(newStory);
            displayStories();
            
            // Wyczy≈õƒá formularz
            document.getElementById('newStoryTitle').value = '';
            document.getElementById('newStoryDescription').value = '';
            
            alert(`‚úÖ Dodano zadanie: ${title}`);
        }

        // ==============================
        // === SZACOWANIE ZADA≈É ===
        // ==============================
        
        function selectEstimation(value) {
            currentEstimation = value;
            document.getElementById('currentEstimation').textContent = value;
            
            // Zaktualizuj wyglƒÖd kart
            document.querySelectorAll('.poker-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Znajd≈∫ i zaznacz wybranƒÖ kartƒô
            event.target.classList.add('selected');
        }

        function submitEstimation() {
            if (!selectedStoryId) {
                alert('‚ùå Wybierz zadanie do oszacowania');
                return;
            }
            
            if (currentEstimation === null) {
                alert('‚ùå Wybierz kartƒô z estymacjƒÖ');
                return;
            }
            
            // Zapisz estymacjƒô u≈ºytkownika
            const story = stories.find(s => s.id === selectedStoryId);
            if (story) {
                story.estimations[currentUser.name] = currentEstimation;
                alert(`‚úÖ Estymacja ${currentEstimation} zapisana dla zadania: ${story.title}`);
                
                // TODO: Po integracji z API wy≈õlij estymacjƒô na serwer:
                // await saveEstimationToAPI(selectedStoryId, currentUser.id, currentEstimation);
            }
        }

        function revealAllVotes() {
            if (!hasPermission('canRevealVotes')) {
                alert('‚ùå Tylko PM mo≈ºe ujawniaƒá g≈Çosy zespo≈Çu');
                return;
            }
            
            if (!selectedStoryId) {
                alert('‚ùå Wybierz zadanie');
                return;
            }
            
            const story = stories.find(s => s.id === selectedStoryId);
            if (story && Object.keys(story.estimations).length > 0) {
                let voteSummary = "üëÅÔ∏è G≈Çosy zespo≈Çu:\n\n";
                Object.entries(story.estimations).forEach(([user, vote]) => {
                    voteSummary += `${user}: ${vote}\n`;
                });
                alert(voteSummary);
            } else {
                alert('‚ùå Brak g≈Ços√≥w do pokazania');
            }
        }

        // ===============================
        // === RETROSPEKTYWA ===
        // ===============================
        
        // Dane notatek retrospektywy
        let retroNotes = {
            start: [],
            stop: [], 
            continue: []
        };
        let noteCounter = 0;

        function addRetroNote(category) {
            const text = prompt(`Wpisz pomys≈Ç dla kategorii ${category.toUpperCase()}:`);
            if (text && text.trim()) {
                noteCounter++;
                const note = {
                    id: noteCounter,
                    text: text.trim(),
                    votes: 0,
                    author: currentUser.name,
                    timestamp: new Date().toLocaleString('pl-PL')
                };
                
                retroNotes[category].push(note);
                displayRetroNotes(category);
            }
        }

        function displayRetroNotes(category) {
            const container = document.getElementById(`${category}-notes`);
            
            container.innerHTML = retroNotes[category].map(note => `
                <div style="background: white; padding: 20px; margin: 12px 0; border-radius: 12px; box-shadow: var(--shadow-sm);">
                    <div style="margin-bottom: 12px; font-weight: 500;">${note.text}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: var(--text-secondary);">
                        <span>üëç ${note.votes} g≈Ços√≥w</span>
                        <button onclick="voteRetroNote(${note.id}, '${category}')" style="background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 16px; cursor: pointer;">G≈Çosuj</button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: var(--text-tertiary);">${note.author} ‚Ä¢ ${note.timestamp}</div>
                </div>
            `).join('');
        }

        function voteRetroNote(noteId, category) {
            const note = retroNotes[category].find(n => n.id === noteId);
            if (note) {
                note.votes++;
                displayRetroNotes(category);
            }
        }

        // ==============================
        // === CHECK-IN I ICEBREAKERS ===
        // ==============================
        
        const icebreakers = [
            'Gdyby≈õ m√≥g≈Ç/mog≈Ça wprowadziƒá jednƒÖ innowacjƒô do Capital Service, co by to by≈Ço?',
            'Jaki by≈Ç najlepszy moment w pracy tego tygodnia?', 
            'Gdyby≈õ by≈Ç/by≈Ça aplikacjƒÖ mobilnƒÖ, jakƒÖ funkcjƒô by≈õ mia≈Ç/mia≈Ça?',
            'Co nowego nauczy≈Çe≈õ/a≈õ siƒô w ostatnim sprincie?',
            'Jaki superbohater najlepiej opisuje Tw√≥j styl pracy w Capital Service?',
            'Kt√≥ra technologia najbardziej Ciƒô teraz ekscytuje i dlaczego?',
            'Jakiej umiejƒôtno≈õci chcia≈Çby≈õ/chcia≈Çaby≈õ siƒô nauczyƒá w tym roku?'
        ];

        function generateNewIcebreaker() {
            const randomIcebreaker = icebreakers[Math.floor(Math.random() * icebreakers.length)];
            document.getElementById('icebreakerQuestion').textContent = randomIcebreaker;
        }

        function selectMood(moodLevel, emoji) {
            document.getElementById('moodResponse').style.display = 'block';
            
            // Animacja wybranego emoji
            event.target.style.transform = 'scale(1.3)';
            setTimeout(() => {
                event.target.style.transform = 'scale(1)';
            }, 300);
            
            // TODO: Po integracji z API wy≈õlij nastr√≥j na serwer:
            // await saveMoodToAPI(currentUser.id, moodLevel);
        }

        // ================================
        // === EKSPORT I RAPORTOWANIE ===
        // ================================
        
        function exportToTeams() {
            if (!hasPermission('canExport')) {
                alert('‚ùå Brak uprawnie≈Ñ do eksportu');
                return;
            }
            
            // TODO: Po integracji z Teams API odkomentowaƒá:
            /*
            async function sendToTeamsChannel() {
                const message = generateRetroSummary();
                await fetch('/api/teams/send-message', {
                    method: 'POST',
                    body: JSON.stringify({ message: message })
                });
            }
            */
            
            alert('üì§ Raport zostanie wys≈Çany do kana≈Çu Teams Capital Service');
        }

        function updateYouTrack() {
            if (!hasPermission('canExport')) {
                alert('‚ùå Brak uprawnie≈Ñ do eksportu');
                return;
            }
            
            // TODO: Po integracji z YouTrack API odkomentowaƒá:
            /*
            async function updateYouTrackEstimations() {
                for (const story of stories) {
                    if (story.finalEstimation) {
                        await fetch('/api/youtrack/update-estimation', {
                            method: 'POST',
                            body: JSON.stringify({
                                taskId: story.id,
                                estimation: story.finalEstimation
                            })
                        });
                    }
                }
            }
            */
            
            alert('üîÑ Estymacje zostanƒÖ zaktualizowane w YouTrack');
        }

        function generatePDFReport() {
            if (!hasPermission('canExport')) {
                alert('‚ùå Brak uprawnie≈Ñ do eksportu');
                return;
            }
            
            // Generowanie raportu PDF
            const reportData = {
                teamName: "Capital Service",
                date: new Date().toLocaleDateString('pl-PL'),
                stories: stories.filter(s => s.finalEstimation),
                retroNotes: retroNotes,
                participants: teamMembers.filter(m => m.presence === 'online').map(m => m.name)
            };
            
            // Prosty spos√≥b generowania "raportu" - mo≈ºna zastƒÖpiƒá prawdziwƒÖ bibliotekƒÖ PDF
            let reportContent = `RAPORT RETROSPEKTYWY CAPITAL SERVICE\n`;
            reportContent += `Data: ${reportData.date}\n`;
            reportContent += `Zesp√≥≈Ç: ${reportData.teamName}\n\n`;
            
            reportContent += `OSZACOWANE ZADANIA:\n`;
            reportData.stories.forEach(story => {
                reportContent += `- ${story.title}: ${story.finalEstimation} SP\n`;
            });
            
            reportContent += `\nUCZESTNICY:\n`;
            reportData.participants.forEach(participant => {
                reportContent += `- ${participant}\n`;
            });
            
            // Pobierz raport jako plik tekstowy
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raport-retro-${reportData.date.replace(/\./g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('üìÑ Raport zostanie pobrany jako plik tekstowy');
        }

        function startRetrospective() {
            showTab('retro');
        }

        // ================================
        // === INICJALIZACJA APLIKACJI ===
        // ================================
        
        // Uruchom aplikacjƒô po za≈Çadowaniu strony
        window.onload = function() {
            console.log('üîÑ RETRO_CSSA Capital Service - inicjalizacja');
            
            // Skonfiguruj interfejs dla aktualnego u≈ºytkownika
            updateUIForCurrentUser();
            
            // Wy≈õwietl cz≈Çonk√≥w zespo≈Çu
            displayTeamMembers();
            
            // Wy≈õwietl zadania
            displayStories();
            
            // Dodaj przyk≈Çadowe notatki retro
            retroNotes.start.push({
                id: 1,
                text: 'Czƒôstsze retrospektywy zespo≈Çowe w Capital Service',
                votes: 3,
                author: 'Anna Nowak',
                timestamp: new Date().toLocaleString('pl-PL')
            });
            
            retroNotes.continue.push({
                id: 2, 
                text: 'Dobra komunikacja miƒôdzy developerami a testerami',
                votes: 5,
                author: 'Monika Capital',
                timestamp: new Date().toLocaleString('pl-PL')
            });
            
            // Wy≈õwietl notatki
            displayRetroNotes('start');
            displayRetroNotes('continue');
            
            // Poka≈º pierwszƒÖ dostƒôpnƒÖ zak≈Çadkƒô
            showFirstAvailableTab();
            
            console.log('‚úÖ Aplikacja za≈Çadowana pomy≈õlnie');
        };
    </script>
</body>
</html>
