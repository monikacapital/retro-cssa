<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETRO_CSSA - Capital Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* === KOLORY I ZMIENNE CSS === */
        :root {
            --primary-blue: #1B365D;
            --secondary-blue: #2E5984;
            --accent-blue: #4A90BE;
            --success-green: #34C759;
            --warning-orange: #FF9500;
            --error-red: #FF3B30;
            --purple-accent: #AF52DE;
            --background-primary: #FAFBFC;
            --background-secondary: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* === PODSTAWOWE STYLE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--background-primary) 0%, #E8F4F8 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 3.5em;
            font-weight: 800;
            margin-bottom: 12px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* === USER INFO === */
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }
        .user-badge {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 25px;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .role-developer {
            background: linear-gradient(135deg, var(--accent-blue), #7BB3D9);
        }
        .role-pm {
            background: linear-gradient(135deg, var(--success-green), #20C997);
        }
        .switch-role-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
        }

        /* === NAVIGATION === */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.8);
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 20px 24px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .tab.hidden {
            display: none !important;
        }
        .tab.active {
            color: var(--primary-blue);
            font-weight: 600;
            border-bottom: 3px solid var(--accent-blue);
        }
        .tab:hover {
            background: rgba(27, 54, 93, 0.05);
            color: var(--primary-blue);
        }

        /* === TAB CONTENT === */
        .tab-content {
            display: none;
            padding: 40px;
            min-height: 600px;
        }
        .tab-content.active {
            display: block;
        }

        /* === CARDS === */
        .modern-card {
            background: var(--background-secondary);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        /* === TEMPLATE SELECTOR === */
        .template-selector {
            display: grid;
            gap: 16px;
        }
        .template-option {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .template-option:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .template-option.selected {
            border-color: var(--primary-blue);
            background: rgba(27, 54, 93, 0.05);
        }
        .template-option h4 {
            color: var(--primary-blue);
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .template-option p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* === BUTTONS === */
        .btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--primary-blue) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 8px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #28A745 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #FD7E14 100%);
        }

        /* === PM ONLY === */
        .pm-only {
            display: block;
        }
        .pm-only.hidden {
            display: none !important;
        }

        /* === TEAM MEMBERS === */
        .team-members {
            display: grid;
            gap: 16px;
        }
        .member-card {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .member-status {
            font-size: 1.5em;
        }
        .member-info {
            flex: 1;
        }
        .member-role {
            background: var(--accent-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85em;
        }

        /* === PLANNING POKER VOTING STATUS === */
        .voting-status {
            background: rgba(74, 144, 190, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }
        .team-voting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .member-vote-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        .member-vote-status.voted {
            border-left-color: var(--success-green);
            background: rgba(52, 199, 89, 0.05);
        }
        .member-vote-status.not-voted {
            border-left-color: var(--warning-orange);
            background: rgba(255, 149, 0, 0.05);
        }
        .vote-indicator {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        /* === POKER CARDS === */
        .poker-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 16px;
            max-width: 900px;
            margin: 32px auto;
        }
        .poker-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 20px 16px;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-blue);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            user-select: none;
        }
        .poker-card:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        .poker-card.selected {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
            color: white;
            transform: translateY(-4px) scale(1.1);
        }
        .poker-card.special {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #FFB84D 100%);
            color: white;
        }

        /* === VOTING RESULTS === */
        .voting-results {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            border: 2px solid var(--accent-blue);
            display: none;
        }
        .voting-results.visible {
            display: block;
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .results-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--accent-blue);
        }
        .individual-votes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        .vote-card {
            background: rgba(74, 144, 190, 0.1);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid var(--accent-blue);
        }
        .vote-value {
            font-size: 2em;
            font-weight: 800;
            color: var(--primary-blue);
            margin-bottom: 8px;
        }
        .vote-author {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        .stat-item {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* === STORIES === */
        .story-list {
            display: grid;
            gap: 16px;
        }
        .story-item {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--accent-blue);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .story-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        .story-item.selected {
            border-left-color: var(--primary-blue);
            background: rgba(27, 54, 93, 0.05);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .container {
                margin: 12px;
            }
            .header h1 {
                font-size: 2.5em;
            }
            .user-info {
                position: static;
                margin-top: 20px;
            }
            .poker-cards {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
            }
            .team-voting-grid {
                grid-template-columns: 1fr;
            }
            .individual-votes {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- === HEADER === -->
        <div class="header">
            <h1>ğŸ”„ RETRO_CSSA</h1>
            <p>Platforma retrospektyw zespoÅ‚owych - Capital Service</p>
            
            <div class="user-info">
                <div id="userBadge" class="user-badge">
                    <div><strong id="userName">Jan Kowalski</strong></div>
                    <div id="userRole">Developer</div>
                </div>
                <button class="switch-role-btn" onclick="switchUserRole()">ğŸ”„ ZmieÅ„ rolÄ™ (demo)</button>
            </div>
        </div>
        
        <!-- === NAVIGATION === -->
        <nav class="nav-tabs">
            <button class="tab" id="tab-setup" onclick="showTab('setup')" data-required-role="pm">âš™ï¸ Konfiguracja</button>
            <button class="tab active" id="tab-planning" onclick="showTab('planning')" data-required-role="developer,pm">ğŸ“‹ Planning Poker</button>
            <button class="tab" id="tab-checkin" onclick="showTab('checkin')" data-required-role="developer,pm">ğŸ‘‹ Check-in</button>
            <button class="tab" id="tab-retro" onclick="showTab('retro')" data-required-role="developer,pm">ğŸ¯ Retrospektywa</button>
            <button class="tab" id="tab-accounts" onclick="showTab('accounts')" data-required-role="pm">ğŸ”— Konta</button>
            <button class="tab" id="tab-summary" onclick="showTab('summary')" data-required-role="pm">ğŸ“Š Raport</button>
        </nav>
        
        <!-- === SETUP === -->
        <div id="setup" class="tab-content">
            <h2 style="margin-bottom: 32px; color: var(--primary-blue);">ğŸš€ Konfiguracja sesji retrospektywy</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <div class="modern-card">
                    <h3 style="color: var(--primary-blue); margin-bottom: 24px;">ğŸ“‹ Wybierz szablon retrospektywy</h3>
                    
                    <div class="template-selector">
                        <div class="template-option selected" onclick="selectTemplate('start-stop-continue', this)">
                            <h4>ğŸ”„ Start/Stop/Continue</h4>
                            <p>Klasyczny szablon agile - co zaczÄ…Ä‡, przestaÄ‡ i kontynuowaÄ‡</p>
                        </div>
                        
                        <div class="template-option" onclick="selectTemplate('4ls', this)">
                            <h4>ğŸ“ 4Ls Framework</h4>
                            <p>Liked, Learned, Lacked, Longed for - pogÅ‚Ä™biona analiza</p>
                        </div>
                        
                        <div class="template-option" onclick="selectTemplate('glad-sad-mad', this)">
                            <h4>ğŸ˜ŠğŸ˜¢ğŸ˜  Glad/Sad/Mad</h4>
                            <p>Emocjonalne spojrzenie na sprint - uczucia zespoÅ‚u</p>
                        </div>
                        
                        <div class="template-option" onclick="selectTemplate('what-worked', this)">
                            <h4>âœ…âŒğŸ’¡ What Worked/Didn't/Try</h4>
                            <p>Fokus na praktyczne rozwiÄ…zania i eksperymenty</p>
                        </div>
                        
                        <div class="template-option" onclick="selectTemplate('team-radar', this)">
                            <h4>ğŸ“¡ Team Radar</h4>
                            <p>Komunikacja, Proces, NarzÄ™dzia, WspÃ³Å‚praca</p>
                        </div>
                        
                        <div class="template-option" onclick="selectTemplate('roses-thorns', this)">
                            <h4>ğŸŒ¹ğŸŒ¿ğŸŒ± Roses/Thorns/Buds</h4>
                            <p>Sukcesy, Problemy, Nowe moÅ¼liwoÅ›ci</p>
                        </div>
                    </div>
                </div>
                
                <div class="modern-card">
                    <h3 style="color: var(--primary-blue); margin-bottom: 24px;">ğŸ‘¥ ZespÃ³Å‚ Capital Service (z Teams)</h3>
                    <div class="team-members" id="teamMembersList"></div>
                    <button class="btn btn-success" onclick="startRetrospective()">â–¶ï¸ Rozpocznij retrospektywÄ™</button>
                </div>
            </div>
        </div>
        
        <!-- === PLANNING POKER === -->
        <div id="planning" class="tab-content active">
            <h2 style="margin-bottom: 32px; color: var(--primary-blue);">ğŸ“‹ Planning Poker - Szacowanie zadaÅ„</h2>
            
            <div class="modern-card pm-only">
                <h3>â• Dodaj nowe zadanie do szacowania</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;">
                    <input type="text" id="newStoryTitle" placeholder="TytuÅ‚ zadania" style="padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                    <input type="text" id="newStoryDescription" placeholder="Opis zadania" style="padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                </div>
                <button class="btn btn-success" onclick="addNewStory()">â• Dodaj zadanie</button>
            </div>
            
            <div class="modern-card">
                <h3>ğŸ“ Zadania do oszacowania</h3>
                <div class="story-list" id="storiesList"></div>
            </div>
            
            <!-- STATUS GÅOSOWANIA ZESPOÅU (tylko PM) -->
            <div class="modern-card pm-only" id="votingStatusPanel" style="display: none;">
                <h3 style="color: var(--primary-blue); margin-bottom: 16px;">ğŸ‘¥ Status gÅ‚osowania zespoÅ‚u</h3>
                <div class="voting-status">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">PostÄ™p gÅ‚osowania:</span>
                        <span id="votingProgress">0/4 czÅ‚onkÃ³w zespoÅ‚u</span>
                    </div>
                    <div class="team-voting-grid" id="teamVotingStatus"></div>
                </div>
            </div>
            
            <div class="modern-card">
                <h3>ğŸ¯ Oszacuj wybrane zadanie</h3>
                <div id="selectedStoryDisplay">
                    <p style="color: var(--text-secondary);">Wybierz zadanie z listy powyÅ¼ej, aby rozpoczÄ…Ä‡ szacowanie</p>
                </div>
                
                <h4 style="margin: 24px 0 16px;">Wybierz swojÄ… estymacjÄ™ (Story Points):</h4>
                <div class="poker-cards">
                    <div class="poker-card" onclick="selectEstimation(0.5)">Â½</div>
                    <div class="poker-card" onclick="selectEstimation(1)">1</div>
                    <div class="poker-card" onclick="selectEstimation(2)">2</div>
                    <div class="poker-card" onclick="selectEstimation(3)">3</div>
                    <div class="poker-card" onclick="selectEstimation(5)">5</div>
                    <div class="poker-card" onclick="selectEstimation(8)">8</div>
                    <div class="poker-card" onclick="selectEstimation(13)">13</div>
                    <div class="poker-card" onclick="selectEstimation(21)">21</div>
                    <div class="poker-card" onclick="selectEstimation(34)">34</div>
                    <div class="poker-card special" onclick="selectEstimation('?')">?</div>
                    <div class="poker-card special" onclick="selectEstimation('âˆ')">âˆ</div>
                    <div class="poker-card special" onclick="selectEstimation('â˜•')">â˜•</div>
                </div>
                
                <div style="text-align: center; margin: 24px 0;">
                    <p>Twoja estymacja: <strong id="currentEstimation">Nie wybrano</strong></p>
                    <button class="btn" onclick="submitEstimation()">âœ… ZatwierdÅº gÅ‚os</button>
                    <button class="btn btn-warning" onclick="revealAllVotes()" id="revealVotesBtn">ğŸ‘ï¸ Ujawnij gÅ‚osy zespoÅ‚u</button>
                    <button class="btn btn-success pm-only" onclick="resetVoting()" style="display: none;" id="resetVotingBtn">ğŸ”„ Nowa runda gÅ‚osowania</button>
                </div>
            </div>
            
            <!-- WYNIKI GÅOSOWANIA -->
            <div class="voting-results" id="votingResults">
                <div class="results-header">
                    <h3 style="color: var(--primary-blue);">ğŸ“Š Wyniki gÅ‚osowania Planning Poker</h3>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Estymacje zespoÅ‚u Capital Service</p>
                </div>
                
                <div class="individual-votes" id="individualVotes"></div>
                
                <div class="statistics-grid" id="statisticsGrid">
                    <div class="stat-item">
                        <div class="stat-value" id="statMin">-</div>
                        <div class="stat-label">Min</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statMax">-</div>
                        <div class="stat-label">Max</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statAvg">-</div>
                        <div class="stat-label">Åšrednia</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statMedian">-</div>
                        <div class="stat-label">Mediana</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCount">-</div>
                        <div class="stat-label">GÅ‚osy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statConsensus">-</div>
                        <div class="stat-label">Konsensus</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--accent-blue);">
                    <button class="btn btn-success pm-only" onclick="acceptEstimation()">âœ… ZatwierdÅº tÄ™ estymacjÄ™</button>
                    <button class="btn pm-only" onclick="assignStory()">ğŸ‘¤ Przypisz do osoby</button>
                </div>
            </div>
        </div>
        
        <!-- === CHECK-IN === -->
        <div id="checkin" class="tab-content">
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: var(--primary-blue); margin-bottom: 24px;">ğŸ‘‹ Check-in zespoÅ‚u Capital Service</h2>
                
                <div class="modern-card" style="max-width: 600px; margin: 32px auto;">
                    <h3>ğŸ’­ Icebreaker dnia</h3>
                    <p id="icebreakerQuestion">KtÃ³ra umiejÄ™tnoÅ›Ä‡, ktÃ³rÄ… rozwijasz teraz, bÄ™dzie Ci najbardziej pomocna za rok?</p>
                    <button class="btn" onclick="generateNewIcebreaker()">ğŸ”„ Nowy icebreaker</button>
                </div>
                
                <h3 style="margin: 32px 0 24px;">ğŸ˜Š Jaki jest TwÃ³j nastrÃ³j dzisiaj?</h3>
                <div style="display: flex; justify-content: center; gap: 24px; margin: 40px 0; flex-wrap: wrap;">
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('excellent', 'ğŸ¤©')" title="DoskonaÅ‚y">ğŸ¤©</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('good', 'ğŸ˜Š')" title="Dobry">ğŸ˜Š</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('neutral', 'ğŸ˜')" title="Neutralny">ğŸ˜</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('bad', 'ğŸ˜”')" title="SÅ‚aby">ğŸ˜”</span>
                    <span style="font-size: 4em; cursor: pointer; padding: 24px; transition: transform 0.3s;" onclick="selectMood('terrible', 'ğŸ˜«')" title="Okropny">ğŸ˜«</span>
                </div>
                
                <div id="moodResponse" style="display: none; margin-top: 32px;">
                    <div class="modern-card" style="max-width: 500px; margin: 0 auto;">
                        <h4 style="color: var(--success-green);">âœ… DziÄ™kujemy za udziaÅ‚ w check-in!</h4>
                        <p>TwÃ³j gÅ‚os jest waÅ¼ny dla zespoÅ‚u Capital Service</p>
                        <button class="btn btn-success" onclick="showTab('retro')">PrzejdÅº do retrospektywy â†’</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- === RETRO === -->
        <div id="retro" class="tab-content">
            <h2 style="color: var(--primary-blue); margin-bottom: 24px;">ğŸ¯ Tablica retrospektywy</h2>
            
            <!-- INFORMACJA O AKTUALNYM SZABLONIE -->
            <div style="background: rgba(74, 144, 190, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                <span style="font-weight: 600;">Aktualny szablon: </span>
                <span id="currentTemplateDisplay">Start/Stop/Continue</span>
                <span style="margin-left: 16px; color: var(--text-secondary);">(moÅ¼na zmieniÄ‡ w Konfiguracji)</span>
            </div>
            
            <!-- PANEL TWORZENIA ZADAÅƒ TO-DO (tylko PM) -->
            <div class="modern-card pm-only" style="background: linear-gradient(135deg, rgba(52, 199, 89, 0.05) 0%, rgba(74, 144, 190, 0.05) 100%); border: 2px solid var(--success-green);">
                <h3 style="color: var(--success-green); margin-bottom: 20px;">ğŸ“ Tworzenie zadaÅ„ To-Do dla zespoÅ‚u (PM)</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Przypisuj konkretne zadania czÅ‚onkom zespoÅ‚u Capital Service. Zadania zostanÄ… automatycznie dodane do Microsoft To-Do przypisanej osoby.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Kolumna 1: Podstawowe informacje -->
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">ğŸ“Œ TytuÅ‚ zadania *</label>
                        <input type="text" id="todoTitle" placeholder="np. Poprawka w module logowania" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; margin-bottom: 16px;">
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">ğŸ‘¤ Przypisz do osoby *</label>
                        <select id="todoAssignee" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; margin-bottom: 16px;">
                            <option value="">-- Wybierz osobÄ™ z zespoÅ‚u --</option>
                        </select>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">ğŸ“… Termin wykonania</label>
                        <input type="date" id="todoDueDate" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px;">
                    </div>
                    
                    <!-- Kolumna 2: SzczegÃ³Å‚y -->
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">ğŸ“‹ Notatka / SzczegÃ³Å‚y</label>
                        <textarea id="todoNotes" placeholder="Dodatkowe informacje, kontekst, linki..." style="width: 100%; height: 120px; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; resize: vertical; margin-bottom: 16px;"></textarea>
                        
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">âš¡ Priorytet</label>
                        <select id="todoPriority" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; margin-bottom: 16px;">
                            <option value="low">ğŸŸ¢ Niski</option>
                            <option value="normal" selected>ğŸŸ¡ Normalny</option>
                            <option value="high">ğŸ”´ Wysoki</option>
                        </select>
                        
                        <label style="display: flex; align-items: center; margin-bottom: 16px;">
                            <input type="checkbox" id="todoReminder" style="margin-right: 8px;">
                            <span>ğŸ”” Ustaw przypomnienie</span>
                        </label>
                    </div>
                </div>
                
                <!-- Przyciski akcji -->
                <div style="text-align: center; padding-top: 16px; border-top: 1px solid rgba(74, 144, 190, 0.2);">
                    <button class="btn btn-success" onclick="createTodoTask()" style="margin-right: 12px;">âœ… UtwÃ³rz zadanie To-Do</button>
                    <button class="btn" onclick="clearTodoForm()" style="background: var(--text-secondary);">ğŸ—‘ï¸ WyczyÅ›Ä‡ formularz</button>
                </div>
                
                <!-- Lista utworzonych zadaÅ„ (podglÄ…d) -->
                <div id="createdTodosPreview" style="margin-top: 24px; display: none;">
                    <h4 style="color: var(--primary-blue); margin-bottom: 16px;">ğŸ“‹ Ostatnio utworzone zadania:</h4>
                    <div id="todosPreviewList"></div>
                </div>
            </div>
            
            <!-- TABLICA RETROSPEKTYWY -->
            <div id="retroBoard"></div>
        </div>
        
        <!-- === ACCOUNTS === -->
        <div id="accounts" class="tab-content">
            <h2 style="color: var(--primary-blue); margin-bottom: 32px;">ğŸ”— Matchowanie kont Teams â†” YouTrack</h2>
            <div class="modern-card">
                <h3>ğŸ“Š Status mapowaÅ„ Capital Service</h3>
                <p>Funkcja dostÄ™pna po integracji z Microsoft Teams i YouTrack</p>
                <div style="background: rgba(74, 144, 190, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <strong>ğŸ”„ Do zaimplementowania:</strong> Automatyczne mapowanie kont zespoÅ‚u
                </div>
            </div>
        </div>
        
        <!-- === SUMMARY === -->
        <div id="summary" class="tab-content">
            <h2 style="color: var(--primary-blue); margin-bottom: 32px;">ğŸ“Š Raport i podsumowanie</h2>
            <div class="modern-card" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%); color: white; text-align: center;">
                <h2>ğŸš€ Eksport i raportowanie</h2>
                <div style="margin: 24px 0;">
                    <p>Generowanie raportÃ³w i eksport danych z retrospektyw Capital Service</p>
                </div>
                <button class="btn" style="background: rgba(255,255,255,0.15);" onclick="exportToTeams()">ğŸ“¤ WyÅ›lij do Teams</button>
                <button class="btn" style="background: rgba(255,255,255,0.15);" onclick="updateYouTrack()">ğŸ”„ Zaktualizuj YouTrack</button>
                <button class="btn" style="background: rgba(255,255,255,0.15);" onclick="generatePDFReport()">ğŸ“„ Raport PDF</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // === ğŸ”´ MOCK DATA SECTION - EASY TO FIND AND REPLACE ===
        // =====================================================
        
        let currentUser = {
            id: "user_001",
            name: "Jan Kowalski",
            email: "jan.kowalski@capitalservice.pl",
            role: "developer",
            avatar: "ğŸ‘¨â€ğŸ’»"
        };

        const teamMembers = [
            {
                id: "user_001",
                name: "Jan Kowalski", 
                email: "jan.kowalski@capitalservice.pl",
                role: "developer",
                presence: "online",
                avatar: "ğŸ‘¨â€ğŸ’»"
            },
            {
                id: "user_002", 
                name: "Anna Nowak",
                email: "anna.nowak@capitalservice.pl", 
                role: "tester",
                presence: "away",
                avatar: "ğŸ‘©â€ğŸ”¬"
            },
            {
                id: "user_003",
                name: "Monika Capital",
                email: "monika.capital@capitalservice.pl",
                role: "pm", 
                presence: "online",
                avatar: "ğŸ‘©â€ğŸ’¼"
            },
            {
                id: "user_004",
                name: "Piotr Kowalczyk", 
                email: "piotr.kowalczyk@capitalservice.pl",
                role: "developer",
                presence: "busy",
                avatar: "ğŸ‘¨â€ğŸ’»"
            }
        ];
        
        let stories = [
            {
                id: 1,
                title: "ğŸ” Implementacja logowania OAuth 2.0",
                description: "Integracja z Microsoft Azure AD dla zespoÅ‚u Capital Service",
                estimations: {},
                finalEstimation: null,
                assignee: null,
                votingSession: {
                    isActive: false,
                    votes: {},
                    revealed: false
                }
            },
            {
                id: 2,
                title: "ğŸ“Š Dashboard z metrykami retrospektyw", 
                description: "Widok statystyk dla Project ManagerÃ³w Capital Service",
                estimations: {},
                finalEstimation: null,
                assignee: null,
                votingSession: {
                    isActive: false,
                    votes: {},
                    revealed: false
                }
            }
        ];

        // =====================================================
        // === ğŸŸ¢ REAL API CALLS SECTION - ODKOMENTUJ PO INTEGRACJI ===
        // =====================================================
        
        /*
        async function loadTeamMembersFromTeams() {
            try {
                const response = await fetch('/api/teams/members', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + getTeamsAccessToken(),
                        'Content-Type': 'application/json'
                    }
                });
                const members = await response.json();
                return members;
            } catch (error) {
                console.error('BÅ‚Ä…d pobierania czÅ‚onkÃ³w zespoÅ‚u z Teams:', error);
                return [];
            }
        }
        */
        
        /*
        async function saveEstimationToYouTrack(taskId, userId, estimation) {
            try {
                const response = await fetch('/api/youtrack/update-estimation', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getYouTrackToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        userId: userId,
                        estimation: estimation
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('BÅ‚Ä…d zapisywania estymacji do YouTrack:', error);
                throw error;
            }
        }
        */

        /*
        async function createMicrosoftTodoTask(taskData) {
            try {
                const todoListResponse = await fetch(`/api/graph/users/${taskData.assigneeId}/todo/lists`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + getMicrosoftAccessToken(),
                        'Content-Type': 'application/json'
                    }
                });
                const todoLists = await todoListResponse.json();
                const defaultList = todoLists.value.find(list => list.displayName === 'Tasks') || todoLists.value[0];
                
                const createTaskResponse = await fetch(`/api/graph/users/${taskData.assigneeId}/todo/lists/${defaultList.id}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getMicrosoftAccessToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: taskData.title,
                        body: {
                            content: taskData.notes,
                            contentType: 'text'
                        },
                        dueDateTime: taskData.dueDate ? {
                            dateTime: taskData.dueDate + 'T23:59:59',
                            timeZone: 'Europe/Warsaw'
                        } : null,
                        importance: taskData.priority,
                        isReminderOn: taskData.reminder
                    })
                });
                
                return await createTaskResponse.json();
            } catch (error) {
                console.error('BÅ‚Ä…d tworzenia zadania Microsoft To-Do:', error);
                throw error;
            }
        }
        */

        // ============================================
        // === ROLE BASED ACCESS CONTROL ===
        // ============================================
        
        const rolePermissions = {
            developer: {
                allowedTabs: ["planning", "checkin", "retro"],
                canExport: false,
                canManageUsers: false,
                canRevealVotes: true,
                canResetVoting: false
            },
            pm: {
                allowedTabs: ["setup", "planning", "checkin", "retro", "accounts", "summary"],
                canExport: true,
                canManageUsers: true, 
                canRevealVotes: true,
                canResetVoting: true
            }
        };

        function hasPermission(permission) {
            return rolePermissions[currentUser.role][permission] || false;
        }

        function updateUIForCurrentUser() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = 
                currentUser.role === 'pm' ? 'Project Manager' : 'Developer';
            
            const userBadge = document.getElementById('userBadge');
            userBadge.className = `user-badge role-${currentUser.role}`;
            
            const allowedTabs = rolePermissions[currentUser.role].allowedTabs;
            document.querySelectorAll('.tab').forEach(tab => {
                const tabId = tab.id.replace('tab-', '');
                if (allowedTabs.includes(tabId)) {
                    tab.classList.remove('hidden');
                } else {
                    tab.classList.add('hidden');
                }
            });
            
            const isPM = currentUser.role === 'pm';
            document.querySelectorAll('.pm-only').forEach(element => {
                if (isPM) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            });
        }

        function switchUserRole() {
            if (currentUser.role === 'developer') {
                currentUser.role = 'pm';
                currentUser.name = 'Monika Capital';
                currentUser.email = 'monika.capital@capitalservice.pl';
                currentUser.avatar = 'ğŸ‘©â€ğŸ’¼';
            } else {
                currentUser.role = 'developer';
                currentUser.name = 'Jan Kowalski';
                currentUser.email = 'jan.kowalski@capitalservice.pl';
                currentUser.avatar = 'ğŸ‘¨â€ğŸ’»';
            }
            
            updateUIForCurrentUser();
            showFirstAvailableTab();
        }

        // =======================================
        // === NAVIGATION ===
        // =======================================
        
        function showTab(tabName) {
            const allowedTabs = rolePermissions[currentUser.role].allowedTabs;
            if (!allowedTabs.includes(tabName)) {
                alert(`âŒ Brak dostÄ™pu do zakÅ‚adki "${tabName}". Wymagana rola: PM`);
                return;
            }

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'retro') {
                generateRetroBoard();
            }
        }

        function showFirstAvailableTab() {
            const allowedTabs = rolePermissions[currentUser.role].allowedTabs;
            const firstTab = allowedTabs[0];
            showTab(firstTab);
        }

        // ========================================
        // === RETRO TEMPLATES ===
        // ========================================
        
        const retroTemplates = {
            'start-stop-continue': {
                name: 'Start/Stop/Continue',
                columns: [
                    { id: 'start', title: 'ğŸš€ START - Co zaczÄ…Ä‡ robiÄ‡?', color: 'rgba(52, 199, 89, 0.1)' },
                    { id: 'stop', title: 'ğŸ›‘ STOP - Co przestaÄ‡ robiÄ‡?', color: 'rgba(255, 59, 48, 0.1)' },
                    { id: 'continue', title: 'âœ… CONTINUE - Co robiÄ‡ dalej?', color: 'rgba(74, 144, 190, 0.1)' }
                ]
            },
            '4ls': {
                name: '4Ls Framework',
                columns: [
                    { id: 'liked', title: 'ğŸ‘ LIKED - Co siÄ™ podobaÅ‚o?', color: 'rgba(52, 199, 89, 0.1)' },
                    { id: 'learned', title: 'ğŸ“ LEARNED - Czego siÄ™ nauczyliÅ›my?', color: 'rgba(74, 144, 190, 0.1)' },
                    { id: 'lacked', title: 'âŒ LACKED - Czego brakowaÅ‚o?', color: 'rgba(255, 149, 0, 0.1)' },
                    { id: 'longed', title: 'ğŸ’­ LONGED - Za czym tÄ™sknimy?', color: 'rgba(175, 82, 222, 0.1)' }
                ]
            },
            'glad-sad-mad': {
                name: 'Glad/Sad/Mad',
                columns: [
                    { id: 'glad', title: 'ğŸ˜Š GLAD - Co nas cieszy?', color: 'rgba(52, 199, 89, 0.1)' },
                    { id: 'sad', title: 'ğŸ˜¢ SAD - Co nas smuci?', color: 'rgba(74, 144, 190, 0.1)' },
                    { id: 'mad', title: 'ğŸ˜  MAD - Co nas zÅ‚oÅ›ci?', color: 'rgba(255, 59, 48, 0.1)' }
                ]
            },
            'what-worked': {
                name: 'What Worked/Didn\'t/Try',
                columns: [
                    { id: 'worked', title: 'âœ… CO DZIAÅAÅO - Sukcesy', color: 'rgba(52, 199, 89, 0.1)' },
                    { id: 'didnt-work', title: 'âŒ CO NIE DZIAÅAÅO - Problemy', color: 'rgba(255, 59, 48, 0.1)' },
                    { id: 'try-next', title: 'ğŸ’¡ CO SPRÃ“BOWAÄ† - Eksperymenty', color: 'rgba(175, 82, 222, 0.1)' }
                ]
            },
            'team-radar': {
                name: 'Team Radar',
                columns: [
                    { id: 'communication', title: 'ğŸ’¬ KOMUNIKACJA', color: 'rgba(52, 199, 89, 0.1)' },
                    { id: 'process', title: 'âš™ï¸ PROCES', color: 'rgba(74, 144, 190, 0.1)' },
                    { id: 'tools', title: 'ğŸ› ï¸ NARZÄ˜DZIA', color: 'rgba(255, 149, 0, 0.1)' },
                    { id: 'collaboration', title: 'ğŸ¤ WSPÃ“ÅPRACA', color: 'rgba(175, 82, 222, 0.1)' }
                ]
            },
            'roses-thorns': {
                name: 'Roses/Thorns/Buds',
                columns: [
                    { id: 'roses', title: 'ğŸŒ¹ ROSES - Sukcesy i radoÅ›ci', color: 'rgba(52, 199, 89, 0.1)' },
                    { id: 'thorns', title: 'ğŸŒ¿ THORNS - Problemy i frustracje', color: 'rgba(255, 59, 48, 0.1)' },
                    { id: 'buds', title: 'ğŸŒ± BUDS - Nowe moÅ¼liwoÅ›ci', color: 'rgba(175, 82, 222, 0.1)' }
                ]
            }
        };
        
        let currentTemplate = 'start-stop-continue';
        let retroNotes = {};

        function selectTemplate(templateKey, clickedElement) {
            console.log('ğŸ”„ Wybrano szablon:', templateKey);
            
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            if (clickedElement) {
                clickedElement.classList.add('selected');
            }
            
            currentTemplate = templateKey;
            
            const template = retroTemplates[templateKey];
            if (template) {
                const oldNotes = {...retroNotes};
                retroNotes = {};
                
                template.columns.forEach(col => {
                    retroNotes[col.id] = oldNotes[col.id] || [];
                });
                
                const templateDisplay = document.getElementById('currentTemplateDisplay');
                if (templateDisplay) {
                    templateDisplay.textContent = template.name;
                }
                
                generateRetroBoard();
                
                console.log('âœ… Szablon zaktualizowany:', templateKey, 'Notatki:', retroNotes);
                alert(`âœ… Wybrano szablon: ${template.name}`);
            } else {
                console.error('âŒ Szablon nie znaleziony:', templateKey);
            }
        }

        function generateRetroBoard() {
            console.log('ğŸ—ï¸ Generowanie tablicy retro dla szablonu:', currentTemplate);
            
            const template = retroTemplates[currentTemplate];
            const board = document.getElementById('retroBoard');
            
            if (!template) {
                console.error('âŒ Nie moÅ¼na wygenerowaÄ‡ tablicy - brak szablonu:', currentTemplate);
                if (board) {
                    board.innerHTML = '<p style="color: red;">BÅ‚Ä…d: Szablon nie znaleziony</p>';
                }
                return;
            }
            
            if (!board) {
                console.error('âŒ Nie znaleziono elementu retroBoard');
                return;
            }
            
            const boardHTML = `
                <div style="text-align: center; margin-bottom: 32px; padding: 20px; background: rgba(74, 144, 190, 0.1); border-radius: 12px;">
                    <h3 style="color: var(--primary-blue); margin-bottom: 8px;">ğŸ“‹ ${template.name}</h3>
                    <p style="color: var(--text-secondary);">Aktywny szablon retrospektywy</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
                    ${template.columns.map(col => `
                        <div style="background: ${col.color}; border-radius: 20px; padding: 32px; box-shadow: var(--shadow-md);">
                            <h3 style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%); color: white; text-align: center; padding: 20px; border-radius: 16px; margin-bottom: 24px; box-shadow: var(--shadow-sm);">
                                ${col.title}
                            </h3>
                            <div style="border: 3px dashed rgba(74, 144, 190, 0.3); border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; cursor: pointer; background: rgba(255,255,255,0.7); transition: all 0.3s ease;" onclick="addRetroNote('${col.id}')" onmouseover="this.style.background='rgba(255,255,255,0.9)'" onmouseout="this.style.background='rgba(255,255,255,0.7)'">
                                + Dodaj nowy pomysÅ‚
                            </div>
                            <div id="${col.id}-notes"></div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            board.innerHTML = boardHTML;
            
            template.columns.forEach(col => {
                displayRetroNotes(col.id);
            });
            
            console.log('âœ… Tablica retro wygenerowana pomyÅ›lnie dla szablonu:', template.name);
        }

        // ========================================
        // === TEAM MEMBERS ===
        // ========================================
        
        function displayTeamMembers() {
            const container = document.getElementById('teamMembersList');
            
            const presenceIcons = {
                online: 'ğŸŸ¢',
                offline: 'âšª', 
                away: 'ğŸŸ¡',
                busy: 'ğŸ”´'
            };
            
            container.innerHTML = teamMembers.map(member => `
                <div class="member-card">
                    <span class="member-status">${presenceIcons[member.presence]} ${member.avatar}</span>
                    <div class="member-info">
                        <div style="font-weight: 600;">${member.name}</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">${member.email}</div>
                    </div>
                    <span class="member-role">${member.role.toUpperCase()}</span>
                </div>
            `).join('');
        }

        // ========================================
        // === PLANNING POKER - ENHANCED WITH VOTING STATUS ===
        // ========================================
        
        let selectedStoryId = null;
        let currentEstimation = null;

        function displayStories() {
            const container = document.getElementById('storiesList');
            
            if (stories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Brak zadaÅ„ do oszacowania. PM moÅ¼e dodaÄ‡ nowe zadania.</p>';
                return;
            }
            
            container.innerHTML = stories.map(story => `
                <div class="story-item ${selectedStoryId === story.id ? 'selected' : ''}" onclick="selectStory(${story.id})">
                    <div style="font-weight: 600; margin-bottom: 8px;">${story.title}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px;">${story.description}</div>
                    <div style="font-size: 0.85em; color: var(--text-tertiary);">
                        ID: ${story.id} | 
                        Estymacja: ${story.finalEstimation ? story.finalEstimation + ' SP' : 'Nie oszacowano'} |
                        Przypisane: ${story.assignee || 'Nieprzypisane'} |
                        GÅ‚osy: ${Object.keys(story.votingSession.votes).length}/${teamMembers.length}
                    </div>
                </div>
            `).join('');
        }

        function selectStory(storyId) {
            selectedStoryId = storyId;
            const story = stories.find(s => s.id === storyId);
            
            if (story) {
                document.getElementById('selectedStoryDisplay').innerHTML = `
                    <div style="background: rgba(74, 144, 190, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                        <h4 style="color: var(--primary-blue); margin-bottom: 8px;">${story.title}</h4>
                        <p style="margin-bottom: 8px;">${story.description}</p>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">
                            <strong>Status:</strong> ${story.finalEstimation ? 'Oszacowane (' + story.finalEstimation + ' SP)' : 'Oczekuje na oszacowanie'} | 
                            <strong>GÅ‚osy:</strong> ${Object.keys(story.votingSession.votes).length}/${teamMembers.length} czÅ‚onkÃ³w zespoÅ‚u
                        </div>
                    </div>
                `;
                
                // PrzywrÃ³Ä‡ gÅ‚os uÅ¼ytkownika jeÅ›li istnieje
                const userVote = story.votingSession.votes[currentUser.id];
                if (userVote) {
                    currentEstimation = userVote;
                    document.getElementById('currentEstimation').textContent = userVote;
                    
                    // Zaznacz kartÄ™
                    document.querySelectorAll('.poker-card').forEach(card => {
                        card.classList.remove('selected');
                        if (card.textContent === userVote.toString()) {
                            card.classList.add('selected');
                        }
                    });
                }

                // Aktualizuj status gÅ‚osowania dla PM
                updateVotingStatus(story);
                
                // PokaÅ¼/ukryj wyniki jeÅ›li juÅ¼ ujawnione
                if (story.votingSession.revealed) {
                    displayVotingResults(story);
                } else {
                    hideVotingResults();
                }
            }
            
            displayStories();
        }

        // NOWA FUNKCJA: Aktualizuj status gÅ‚osowania zespoÅ‚u (dla PM)
        function updateVotingStatus(story) {
            if (currentUser.role !== 'pm') {
                document.getElementById('votingStatusPanel').style.display = 'none';
                return;
            }

            const statusPanel = document.getElementById('votingStatusPanel');
            const progressElement = document.getElementById('votingProgress');
            const teamStatusContainer = document.getElementById('teamVotingStatus');
            
            const votedCount = Object.keys(story.votingSession.votes).length;
            const totalCount = teamMembers.length;
            
            progressElement.textContent = `${votedCount}/${totalCount} czÅ‚onkÃ³w zespoÅ‚u`;
            
            teamStatusContainer.innerHTML = teamMembers.map(member => {
                const hasVoted = story.votingSession.votes.hasOwnProperty(member.id);
                const statusClass = hasVoted ? 'voted' : 'not-voted';
                const statusIcon = hasVoted ? 'âœ…' : 'â³';
                const statusText = hasVoted ? 'ZagÅ‚osowaÅ‚' : 'Oczekuje na gÅ‚os';
                
                return `
                    <div class="member-vote-status ${statusClass}">
                        <div class="vote-indicator">${statusIcon}</div>
                        <div class="member-info">
                            <div style="font-weight: 600;">${member.name}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">${statusText}</div>
                        </div>
                        <div style="font-size: 0.8em; color: var(--text-tertiary);">${member.role}</div>
                    </div>
                `;
            }).join('');
            
            statusPanel.style.display = 'block';
        }

        function addNewStory() {
            if (!hasPermission('canManageUsers')) {
                alert('âŒ Tylko PM moÅ¼e dodawaÄ‡ zadania');
                return;
            }
            
            const title = document.getElementById('newStoryTitle').value.trim();
            const description = document.getElementById('newStoryDescription').value.trim();
            
            if (!title) {
                alert('âŒ WprowadÅº tytuÅ‚ zadania');
                return;
            }
            
            const newStory = {
                id: Date.now(),
                title: title,
                description: description || 'Brak szczegÃ³Å‚owego opisu',
                estimations: {},
                finalEstimation: null,
                assignee: null,
                votingSession: {
                    isActive: false,
                    votes: {},
                    revealed: false
                }
            };
            
            stories.push(newStory);
            displayStories();
            
            document.getElementById('newStoryTitle').value = '';
            document.getElementById('newStoryDescription').value = '';
            
            alert(`âœ… Dodano zadanie: ${title}`);
        }

        // ==============================
        // === ESTIMATION - ENHANCED ===
        // ==============================
        
        function selectEstimation(value) {
            currentEstimation = value;
            document.getElementById('currentEstimation').textContent = value;
            
            document.querySelectorAll('.poker-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
        }

        function submitEstimation() {
            if (!selectedStoryId) {
                alert('âŒ Wybierz zadanie do oszacowania');
                return;
            }
            
            if (currentEstimation === null) {
                alert('âŒ Wybierz kartÄ™ z estymacjÄ…');
                return;
            }
            
            const story = stories.find(s => s.id === selectedStoryId);
            if (story) {
                // Zapisz gÅ‚os w voting session
                story.votingSession.votes[currentUser.id] = currentEstimation;
                story.votingSession.isActive = true;
                
                // RÃ³wnieÅ¼ zapisz w starym formacie dla kompatybilnoÅ›ci
                story.estimations[currentUser.name] = currentEstimation;
                
                alert(`âœ… Estymacja ${currentEstimation} zapisana dla zadania: ${story.title}`);
                
                // Aktualizuj status gÅ‚osowania
                updateVotingStatus(story);
                displayStories();
                
                // ğŸŸ¢ REAL API: Odkomentuj gdy YouTrack API bÄ™dzie gotowe
                // await saveEstimationToYouTrack(selectedStoryId, currentUser.id, currentEstimation);
            }
        }

        // NOWA FUNKCJA: WyÅ›wietl wyniki gÅ‚osowania z peÅ‚nymi statystykami
        function revealAllVotes() {
            if (!hasPermission('canRevealVotes')) {
                alert('âŒ Brak uprawnieÅ„ do ujawniania gÅ‚osÃ³w');
                return;
            }
            
            if (!selectedStoryId) {
                alert('âŒ Wybierz zadanie');
                return;
            }
            
            const story = stories.find(s => s.id === selectedStoryId);
            if (!story || Object.keys(story.votingSession.votes).length === 0) {
                alert('âŒ Brak gÅ‚osÃ³w do pokazania');
                return;
            }
            
            story.votingSession.revealed = true;
            displayVotingResults(story);
            
            // PokaÅ¼ przycisk reset dla PM
            if (hasPermission('canResetVoting')) {
                document.getElementById('resetVotingBtn').style.display = 'inline-block';
            }
        }

        function displayVotingResults(story) {
            const resultsContainer = document.getElementById('votingResults');
            const individualVotesContainer = document.getElementById('individualVotes');
            
            // PokaÅ¼ panel wynikÃ³w
            resultsContainer.classList.add('visible');
            
            // WyÅ›wietl indywidualne gÅ‚osy
            const votes = story.votingSession.votes;
            individualVotesContainer.innerHTML = Object.entries(votes).map(([userId, vote]) => {
                const member = teamMembers.find(m => m.id === userId);
                return `
                    <div class="vote-card">
                        <div class="vote-value">${vote}</div>
                        <div class="vote-author">${member ? member.name : 'Nieznany'}</div>
                    </div>
                `;
            }).join('');
            
            // Oblicz statystyki
            const numericVotes = Object.values(votes).filter(v => typeof v === 'number' || !isNaN(parseFloat(v))).map(v => parseFloat(v));
            
            if (numericVotes.length > 0) {
                const min = Math.min(...numericVotes);
                const max = Math.max(...numericVotes);
                const avg = (numericVotes.reduce((a, b) => a + b, 0) / numericVotes.length).toFixed(1);
                
                const sorted = [...numericVotes].sort((a, b) => a - b);
                const median = sorted.length % 2 === 0 
                    ? ((sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2).toFixed(1)
                    : sorted[Math.floor(sorted.length / 2)];
                
                // SprawdÅº konsensus (rÃ³Å¼nica miÄ™dzy max a min <= 2)
                const consensus = (max - min <= 2) ? 'TAK' : 'NIE';
                
                // Aktualizuj statystyki
                document.getElementById('statMin').textContent = min;
                document.getElementById('statMax').textContent = max;
                document.getElementById('statAvg').textContent = avg;
                document.getElementById('statMedian').textContent = median;
                document.getElementById('statCount').textContent = numericVotes.length;
                document.getElementById('statConsensus').textContent = consensus;
            } else {
                // JeÅ›li tylko gÅ‚osy specjalne (?, âˆ, â˜•)
                document.getElementById('statMin').textContent = '-';
                document.getElementById('statMax').textContent = '-';
                document.getElementById('statAvg').textContent = '-';
                document.getElementById('statMedian').textContent = '-';
                document.getElementById('statCount').textContent = Object.keys(votes).length;
                document.getElementById('statConsensus').textContent = 'SPEC';
            }
        }

        function hideVotingResults() {
            document.getElementById('votingResults').classList.remove('visible');
            document.getElementById('resetVotingBtn').style.display = 'none';
        }

        function resetVoting() {
            if (!hasPermission('canResetVoting')) {
                alert('âŒ Tylko PM moÅ¼e resetowaÄ‡ gÅ‚osowanie');
                return;
            }
            
            if (!selectedStoryId) {
                alert('âŒ Wybierz zadanie');
                return;
            }
            
            const story = stories.find(s => s.id === selectedStoryId);
            if (story) {
                story.votingSession.votes = {};
                story.votingSession.revealed = false;
                story.estimations = {};
                
                hideVotingResults();
                updateVotingStatus(story);
                displayStories();
                
                // Reset UI
                currentEstimation = null;
                document.getElementById('currentEstimation').textContent = 'Nie wybrano';
                document.querySelectorAll('.poker-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                alert('ğŸ”„ Nowa runda gÅ‚osowania rozpoczÄ™ta');
            }
        }

        function acceptEstimation() {
            if (!hasPermission('canManageUsers')) {
                alert('âŒ Tylko PM moÅ¼e zatwierdzaÄ‡ estymacje');
                return;
            }
            
            if (!selectedStoryId) {
                alert('âŒ Wybierz zadanie');
                return;
            }
            
            const story = stories.find(s => s.id === selectedStoryId);
            if (!story || !story.votingSession.revealed) {
                alert('âŒ Najpierw ujawnij gÅ‚osy zespoÅ‚u');
                return;
            }
            
            const votes = Object.values(story.votingSession.votes);
            const numericVotes = votes.filter(v => typeof v === 'number' || !isNaN(parseFloat(v))).map(v => parseFloat(v));
            
            let finalEstimation;
            if (numericVotes.length > 0) {
                // UÅ¼yj mediany jako ostatecznej estymacji
                const sorted = [...numericVotes].sort((a, b) => a - b);
                finalEstimation = sorted.length % 2 === 0 
                    ? Math.round((sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2)
                    : sorted[Math.floor(sorted.length / 2)];
            } else {
                finalEstimation = prompt('WprowadÅº ostatecznÄ… estymacjÄ™ (gÅ‚osy specjalne nie pozwalajÄ… na automatyczne obliczenie):');
                if (!finalEstimation) return;
                finalEstimation = parseFloat(finalEstimation);
            }
            
            story.finalEstimation = finalEstimation;
            
            alert(`âœ… Estymacja zatwierdzona: ${finalEstimation} SP dla zadania "${story.title}"`);
            
            // Aktualizuj wyÅ›wietlanie
            selectStory(selectedStoryId);
        }

        function assignStory() {
            if (!hasPermission('canManageUsers')) {
                alert('âŒ Tylko PM moÅ¼e przypisywaÄ‡ zadania');
                return;
            }
            
            if (!selectedStoryId) {
                alert('âŒ Wybierz zadanie');
                return;
            }
            
            const story = stories.find(s => s.id === selectedStoryId);
            if (!story) return;
            
            const memberNames = teamMembers.map(m => m.name).join('\n');
            const assignee = prompt(`Przypisz zadanie do osoby:\n\nDostÄ™pni czÅ‚onkowie zespoÅ‚u:\n${memberNames}\n\nWpisz imiÄ™ i nazwisko:`);
            
            if (assignee && teamMembers.find(m => m.name === assignee)) {
                story.assignee = assignee;
                alert(`âœ… Zadanie "${story.title}" przypisane do: ${assignee}`);
                selectStory(selectedStoryId);
            } else if (assignee) {
                alert('âŒ Nie znaleziono takiego czÅ‚onka zespoÅ‚u');
            }
        }

        // ===============================
        // === RETRO NOTES ===
        // ===============================
        
        let noteCounter = 0;

        function addRetroNote(category) {
            const text = prompt(`Wpisz pomysÅ‚ dla kategorii ${category.toUpperCase()}:`);
            if (text && text.trim()) {
                noteCounter++;
                const note = {
                    id: noteCounter,
                    text: text.trim(),
                    votes: 0,
                    author: currentUser.name,
                    timestamp: new Date().toLocaleString('pl-PL')
                };
                
                retroNotes[category] = retroNotes[category] || [];
                retroNotes[category].push(note);
                displayRetroNotes(category);
                
                console.log('âœ… Dodano notatkÄ™ do kategorii:', category, note);
            }
        }

        function displayRetroNotes(category) {
            const container = document.getElementById(`${category}-notes`);
            if (!container) {
                console.warn('âš ï¸ Nie znaleziono kontenera dla kategorii:', category);
                return;
            }
            
            const notes = retroNotes[category] || [];
            
            container.innerHTML = notes.map(note => `
                <div style="background: white; padding: 20px; margin: 12px 0; border-radius: 12px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--accent-blue);">
                    <div style="margin-bottom: 12px; font-weight: 500; color: var(--text-primary);">${note.text}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: var(--text-secondary);">
                        <span>ğŸ‘ ${note.votes} gÅ‚osÃ³w</span>
                        <button onclick="voteRetroNote(${note.id}, '${category}')" style="background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 16px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">GÅ‚osuj</button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: var(--text-tertiary);">${note.author} â€¢ ${note.timestamp}</div>
                </div>
            `).join('');
            
            console.log('âœ… WyÅ›wietlono notatki dla kategorii:', category, notes.length, 'notatek');
        }

        function voteRetroNote(noteId, category) {
            const note = (retroNotes[category] || []).find(n => n.id === noteId);
            if (note) {
                note.votes++;
                displayRetroNotes(category);
                console.log('âœ… GÅ‚os oddany na notatkÄ™:', noteId, 'nowa liczba gÅ‚osÃ³w:', note.votes);
            }
        }

        // ===============================
        // === MICROSOFT TO-DO INTEGRATION ===
        // ===============================

        let createdTodos = [];

        function populateAssigneeSelect() {
            const select = document.getElementById('todoAssignee');
            if (!select) return;
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.role}) ${member.presence === 'online' ? 'ğŸŸ¢' : 'âšª'}`;
                select.appendChild(option);
            });
        }

        function canCreateTodos() {
            return currentUser.role === 'pm';
        }

        function validateTodoForm() {
            const title = document.getElementById('todoTitle').value.trim();
            const assignee = document.getElementById('todoAssignee').value;
            
            if (!title) {
                alert('âŒ WprowadÅº tytuÅ‚ zadania');
                return false;
            }
            
            if (!assignee) {
                alert('âŒ Wybierz osobÄ™, do ktÃ³rej przypisaÄ‡ zadanie');
                return false;
            }
            
            return true;
        }

        async function createTodoTask() {
            if (!canCreateTodos()) {
                alert('âŒ Tylko Project Manager moÅ¼e tworzyÄ‡ zadania To-Do');
                return;
            }
            
            if (!validateTodoForm()) {
                return;
            }
            
            const taskData = {
                title: document.getElementById('todoTitle').value.trim(),
                assigneeId: document.getElementById('todoAssignee').value,
                assigneeName: document.getElementById('todoAssignee').selectedOptions[0].textContent.split(' (')[0],
                dueDate: document.getElementById('todoDueDate').value,
                notes: document.getElementById('todoNotes').value.trim(),
                priority: document.getElementById('todoPriority').value,
                reminder: document.getElementById('todoReminder').checked,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };
            
            try {
                // ğŸŸ¢ REAL API: Odkomentuj gdy Microsoft Graph API bÄ™dzie gotowe
                // const createdTask = await createMicrosoftTodoTask(taskData);
                
                // ğŸ”´ MOCK: Symulacja tworzenia zadania
                const mockCreatedTask = {
                    id: `todo_${Date.now()}`,
                    ...taskData,
                    status: 'created'
                };
                
                createdTodos.push(mockCreatedTask);
                
                alert(`âœ… Zadanie utworzone pomyÅ›lnie!\n\nğŸ“Œ TytuÅ‚: ${taskData.title}\nğŸ‘¤ Przypisane do: ${taskData.assigneeName}\nğŸ“… Termin: ${taskData.dueDate || 'Nie ustawiono'}\n\nZadanie zostaÅ‚o dodane do Microsoft To-Do uÅ¼ytkownika ${taskData.assigneeName}.`);
                
                clearTodoForm();
                displayCreatedTodosPreview();
                
                console.log('âœ… Zadanie To-Do utworzone:', mockCreatedTask);
                
            } catch (error) {
                console.error('âŒ BÅ‚Ä…d tworzenia zadania To-Do:', error);
                alert('âŒ WystÄ…piÅ‚ bÅ‚Ä…d podczas tworzenia zadania. SprÃ³buj ponownie.');
            }
        }

        function clearTodoForm() {
            document.getElementById('todoTitle').value = '';
            document.getElementById('todoAssignee').value = '';
            document.getElementById('todoDueDate').value = '';
            document.getElementById('todoNotes').value = '';
            document.getElementById('todoPriority').value = 'normal';
            document.getElementById('todoReminder').checked = false;
        }

        function displayCreatedTodosPreview() {
            const preview = document.getElementById('createdTodosPreview');
            const list = document.getElementById('todosPreviewList');
            
            if (createdTodos.length === 0) {
                preview.style.display = 'none';
                return;
            }
            
            preview.style.display = 'block';
            
            const recentTodos = createdTodos.slice(-3).reverse();
            
            list.innerHTML = recentTodos.map(todo => `
                <div style="background: white; padding: 16px; margin: 8px 0; border-radius: 8px; border-left: 4px solid var(--success-green); box-shadow: var(--shadow-sm);">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">ğŸ“Œ ${todo.title}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ‘¤ Przypisane do: ${todo.assigneeName}</div>
                            ${todo.dueDate ? `<div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ“… Termin: ${new Date(todo.dueDate).toLocaleDateString('pl-PL')}</div>` : ''}
                            ${todo.notes ? `<div style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 8px;">ğŸ’¬ ${todo.notes}</div>` : ''}
                        </div>
                        <div style="font-size: 0.8em; color: var(--text-tertiary); text-align: right;">
                            ${new Date(todo.createdAt).toLocaleString('pl-PL')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setDefaultDueDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const dueDateInput = document.getElementById('todoDueDate');
            if (dueDateInput) {
                dueDateInput.value = tomorrowStr;
            }
        }

        // ==============================
        // === ICEBREAKERS ===
        // ==============================
        
        const icebreakers = [
            'KtÃ³ra umiejÄ™tnoÅ›Ä‡, ktÃ³rÄ… rozwijasz teraz, bÄ™dzie Ci najbardziej pomocna za rok?',
            'Co ostatnio nauczyÅ‚o CiÄ™ czegoÅ› nowego o sobie?',
            'JakÄ… jednÄ… rzecz zmieniÅ‚byÅ› w swoim codziennym workflow?',
            'Co sprawia, Å¼e czujesz siÄ™ dumny ze swojej pracy?',
            'Jakiej lekcji nauczyÅ‚eÅ› siÄ™ od wspÃ³Å‚pracownika w ostatnim czasie?',
            'Co motywuje CiÄ™ do lepszej pracy z zespoÅ‚em?',
            'Jaki problem rozwiÄ…zaÅ‚eÅ› ostatnio w nietypowy sposÃ³b?',
            'Co chciaÅ‚byÅ›, Å¼eby TwÃ³j zespÃ³Å‚ wiedziaÅ‚ o Twojej pracy?',
            'KtÃ³ra technologia/narzÄ™dzie najbardziej zmieniÅ‚o TwÃ³j sposÃ³b pracy?',
            'Co sprawia, Å¼e praca w Capital Service ma sens?'
        ];

        function generateNewIcebreaker() {
            const randomIcebreaker = icebreakers[Math.floor(Math.random() * icebreakers.length)];
            document.getElementById('icebreakerQuestion').textContent = randomIcebreaker;
        }

        function selectM
